{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ChitChat</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .topbar-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100vw;
            height: 10vh;
            min-height: 50px;
            max-height: 100px;
            background: #e9e9f0;
            padding: 0 2rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        .topbar-container button {
            margin: 0 0.5rem;
        }
        .chat-container {
            background: #fff;
            padding: 2rem 2.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: 70vh;
            min-width: 70vw;
            max-width: 100vw;
            overflow-y: auto;
        }
        h2 { margin-bottom: 1.5rem; color: #333; }
        form { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; color: #555; }
        input[type="text"], input[type="password"] { padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 0.6rem; background: #4a90e2; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #357abd; }
</style>
</head>
<body>
    <div class="topbar-container">
      <button onclick="window.location.href='{% url 'home' %}'">Home</button>
              <h2>Chat with {{ chat }}</h2>
      <form method="post" action="{% url 'logout' %}" style="display:inline; margin: 0;">
        {% csrf_token %}
        <button type="submit">Logout</button>
      </form>
    </div>
    <div class="chat-container" id="chat-container">
        {% include '_messages.html' %}
    </div>

    {% comment %} <script>
      // Scroll chat container to bottom on page load
      document.addEventListener('DOMContentLoaded', function() {
        var chatContainer = document.getElementById('chat-container');
        if (chatContainer) {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      });
    </script> {% endcomment %}



    <div class="send-message-container" style="height:20vh; width:80vw; overflow-y:auto; margin: 1rem auto 0 auto; display: flex; align-items: center; justify-content: center;">
      <form id="send-message-form" method="post" action="{% url 'send_message' %}" style="width:100%; display: flex; align-items: center;">
        {% csrf_token %}
        <div style="flex: 0 0 90%; max-width: 90%;">
          {{ message_form.as_p }}
          <input type="hidden" name="chat_number" value="{{chat_number}}">
        </div>
        <div style="flex: 0 0 10%; max-width: 10%; display: flex; align-items: center; justify-content: flex-end;">
          <button type="submit" style="width: 100%;">Send Message</button>
        </div>
      </form>
    </div>

    {% comment %} <script>
      document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('send-message-form');
      const input = form.querySelector('input[type="text"], textarea');
      if (input) {
        input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
        });
      }
      });
    </script> {% endcomment %}

    <script src="{% static 'js/submitWithEnter.js' %}"></script>
    <script src="{% static 'js/scrollToBottom.js' %}"></script>
    <script>

      submitWithEnterListener('send-message-form', 'input[type="text"], textarea');
      document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom('chat-container');
      });
    </script>

<script>
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('send-message-form');
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          fetch("{% url 'send_message_async' %}", {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              form.reset();
            }
            else {
              alert('An error occurred.');
            }
          });
        });
      });
    </script>

    <script>
        let lastMessageNumber = document.getElementById("last-message-number").dataset.lastMessageNumber;

        function fetchNewMessages() {
          fetch("{% url 'get_new_messages' %}?chat_pk={{chat.pk}}&last_message_number=" + lastMessageNumber)
            .then(response => response.json())
            .then(data => {
              if (data.last_message_number != lastMessageNumber) { 
                document.getElementById("chat-container").insertAdjacentHTML('beforeend', data.html);
                lastMessageNumber = data.last_message_number;
                document.getElementById("last-message-number").dataset.lastMessageNumber = lastMessageNumber;
                if (data.new_message_this_user) {
                  scrollToBottom('chat-container');
                }
                return data;
              }
            }
            )
            .finally(() => {
              setTimeout(fetchNewMessages, 200);
              
            });
        }


        fetchNewMessages();
      </script>