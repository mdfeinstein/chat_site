{% load static %}
{% load django_vite %}
<!DOCTYPE html>
<html lang="en">
<head>
        <script type="module">
      import RefreshRuntime from 'http://localhost:5173/@react-refresh'
      RefreshRuntime.injectIntoGlobalHook(window)
      window.$RefreshReg$ = () => {}
      window.$RefreshSig$ = () => (type) => type
      window.__vite_plugin_react_preamble_installed__ = true
  </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ChitChat</title>
    {% vite_hmr_client %}
    {% vite_asset 'src/main.tsx' %}
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .topbar-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100vw;
            height: 10vh;
            min-height: 50px;
            max-height: 100px;
            background: #e9e9f0;
            padding: 0 2rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        .topbar-container button {
            margin: 0 0.5rem;
        }
        .chat-container {
            background: #fff;
            padding: 2rem 2.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: 70vh;
            min-width: 70vw;
            max-width: 100vw;
            overflow-y: auto;
        }
        h2 { margin-bottom: 1.5rem; color: #333; }
        form { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; color: #555; }
        input[type="text"], input[type="password"] { padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 0.6rem; background: #4a90e2; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #357abd; }
        
        {% comment %} #send-message-form { 
          display: flex;
          flex-direction: row;
          width: 80%;
          height: 100px;
          box-sizing: border-box;
          }

          .chat-textarea {
          flex: 0 0 80%;
          height: 100%;
          box-sizing: border-box;
          }

        .send-message-button {
          flex: 0 0 20%;
          height: 100%;
          box-sizing: border-box;
          } {% endcomment %}


</style>
</head>
<body>
    <div class="topbar-container">
      <button onclick="window.location.href='{% url 'home' %}'">Home</button>
              <h2>Chat with {{ chat }}</h2>
      <form method="post" action="{% url 'exit_chat' %}">
        {% csrf_token %}
        <input type="hidden" name="chat_pk" value="{{chat.pk}}">
        <button type="submit" style="align-self: right;">Exit Chat</button>
      </form>
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" style="align-self: right;">Logout</button>
      </form>
    </div>
    
    <div 
      class="chat-container" 
      id="chat-container"
      data-get-new-messages-url="{% url 'get_new_messages' %}"
      data-chat-id="{{ chat.pk }}"
    >
        {% include '_messages.html' %}
    </div>

    <div
      id="react-message-form"
      data-url="{% url 'send_message_async' %}"
      data-chat-id="{{ chat_number }}"
      style="width: 100%; max-width: 90vw; margin-top: 0.5rem;"
    >
        {% csrf_token %}
    </div>


    <script src="{% static 'js/scrollToBottom.js' %}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom('chat-container');
      });
    </script>

    {% comment %} <script>
        let lastMessageNumber = document.getElementById("last-message-number").dataset.lastMessageNumber;

        function fetchNewMessages() {
          fetch("{% url 'get_new_messages' %}?chat_pk={{chat.pk}}&last_message_number=" + lastMessageNumber)
            .then(response => response.json())
            .then(data => {
              if (data.last_message_number != lastMessageNumber) { 
                document.getElementById("chat-container").insertAdjacentHTML('beforeend', data.html);
                lastMessageNumber = data.last_message_number;
                document.getElementById("last-message-number").dataset.lastMessageNumber = lastMessageNumber;
                if (data.new_message_this_user) {
                  scrollToBottom('chat-container');
                }
                return data;
              }
            }
            )
            .finally(() => {
              setTimeout(fetchNewMessages, 200);
              
            });
        }


        fetchNewMessages();
      </script> {% endcomment %}
    </body>
  </html>